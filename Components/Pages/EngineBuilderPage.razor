@page "/enginebuilder"
@* Explicitly disable prerendering to help with scoped service persistence across same-page navigation *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject RotaryEngineDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject rotaryproject.Services.EngineBuildStateService BuildStateService
@using Microsoft.AspNetCore.Identity
@using rotaryproject.Data
@using rotaryproject.Data.Models
@using Microsoft.EntityFrameworkCore

<PageTitle>Build Your Rotary Engine</PageTitle>

<h1>Choose Your Engine Parts</h1>

<div class="compatibility-summary my-3 p-3 bg-light border rounded" style="min-height: 50px;">
    <p class="mb-0"><em>Compatibility and overall stats will appear here. Current Total: @BuildStateService.CurrentBuild.TotalPrice.ToString("C")</em></p>
</div>

@if (isLoadingCategories)
{
    <p><em>Loading engine component structure...</em></p>
}
else if (engineMainCategories == null || !engineMainCategories.Any())
{
    <p><em>No engine component categories found. Please set up main and subcategories.</em></p>
}
else
{
    @* --- "SHARE YOUR BUILD" & "SAVE BUILD" BLOCKS --- *@
    @if (BuildStateService.CurrentBuild.SelectedParts.Any())
    {
        <div class="mt-4 mb-3 p-3 border rounded bg-light">
            <h4>Share Your Build</h4>
            <div class="input-group">
                <input type="text" class="form-control" @bind="shareableLink" readonly
                       placeholder="Click 'Generate Link' to create a shareable link." />
                <button class="btn btn-info" @onclick="GenerateShareableLink">Generate Link</button>
                @if (!string.IsNullOrEmpty(shareableLink))
                {
                    <button class="btn btn-outline-secondary" @onclick="CopyLinkToClipboard">Copy</button>
                }
            </div>
            @if (linkCopied)
            {
                <small class="text-success d-block mt-1">Link copied to clipboard!</small>
            }
        </div>

        <AuthorizeView>
            <Authorized>
                <div class="mt-3 p-3 border rounded bg-white">
                    <h4>Save This Build</h4>
                    @if (!string.IsNullOrEmpty(saveBuildMessage))
                    {
                        <div class="alert @(saveBuildSuccess ? "alert-success" : "alert-danger")">@saveBuildMessage</div>
                    }
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="newBuildName" placeholder="Enter a name for your build" />
                        <button class="btn btn-success" @onclick="SaveCurrentBuild" disabled="@string.IsNullOrWhiteSpace(newBuildName)">Save Build</button>
                    </div>
                    <small class="form-text text-muted">Name your build to save it to your account.</small>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="mt-3 p-3 border rounded bg-light-subtle">
                    <p class="mb-0">Want to save this build? <a href="Account/Login?returnUrl=@ReturnUrlForLogin">Log in</a> or <a href="Account/Register">Register</a> to save your builds!</p>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    }

    @* --- HIERARCHICAL PARTS TABLE --- *@
    <div class="table-responsive mt-3">
        <table class="table engine-builder-table table-hover">
            <thead class="table-light">
                <tr>
                    <th style="width: 25%;">Component Group / Subcomponent</th>
                    <th style="width: 10%;">Image</th>
                    <th style="width: 25%;">Selection</th>
                    <th style="width: 10%;">Availability</th>
                    <th style="width: 10%;">Vendor</th>
                    <th style="width: 10%;">Price</th>
                    <th style="width: 15%;">Actions / Buy</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var mainCategory in engineMainCategories.OrderBy(m => m.DisplayOrder).ThenBy(m => m.Name))
                {
                    <tr class="table-group-divider">
                        <td colspan="7">
                            <h5 role="button" @onclick="() => ToggleMainCategory(mainCategory.EngineMainCategoryId)" style="cursor: pointer;">
                                <span class="bi @(expandedMainCategories.Contains(mainCategory.EngineMainCategoryId) ? "bi-chevron-down" : "bi-chevron-right")"></span>
                                @mainCategory.Name
                            </h5>
                        </td>
                    </tr>
                    @if (expandedMainCategories.Contains(mainCategory.EngineMainCategoryId))
                    {
                        @foreach (var subCategory in mainCategory.SubCategories.OrderBy(s => s.DisplayOrder).ThenBy(s => s.Name))
                        {
                            <tr>
                                <td class="ps-4">@subCategory.Name</td>
                                <td>
                                    @if (BuildStateService.CurrentBuild.SelectedParts.TryGetValue(subCategory.EngineSubCategoryId, out Part? imgPart) && imgPart != null && !string.IsNullOrEmpty(imgPart.ImagePath))
                                    {
                                        <img src="@imgPart.ImagePath" alt="@imgPart.Name" style="max-width: 75px; max-height: 75px; object-fit: contain;"
                                             onerror="this.onerror=null; this.src='https://placehold.co/75x75/e1e1e1/777?text=No+Image';" />
                                    }
                                    else if (BuildStateService.CurrentBuild.SelectedParts.ContainsKey(subCategory.EngineSubCategoryId))
                                    {
                                        <img src="https://placehold.co/75x75/e1e1e1/777?text=No+Image" alt="No image available" style="max-width: 75px; max-height: 75px; object-fit: contain;" />
                                    }
                                </td>
                                <td>
                                    @if (BuildStateService.CurrentBuild.SelectedParts.TryGetValue(subCategory.EngineSubCategoryId, out Part? selectedPart) && selectedPart != null)
                                    {
                                        <a href="/partdetail/@selectedPart.PartId"><strong>@selectedPart.Name</strong></a>
                                        @if(!string.IsNullOrWhiteSpace(selectedPart.Brand))
                                        {
                                            <br /><small class="text-muted">Brand: @selectedPart.Brand</small>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">No part selected</span>
                                    }
                                </td>
                                <td>
                                    @if (BuildStateService.CurrentBuild.SelectedParts.TryGetValue(subCategory.EngineSubCategoryId, out Part? availPart) && availPart != null && !string.IsNullOrEmpty(availPart.Availability))
                                    { <span>@availPart.Availability</span> }
                                    else if (BuildStateService.CurrentBuild.SelectedParts.ContainsKey(subCategory.EngineSubCategoryId))
                                    { <span class="text-muted">-</span> }
                                </td>
                                <td>
                                    @if (BuildStateService.CurrentBuild.SelectedParts.TryGetValue(subCategory.EngineSubCategoryId, out Part? vendorPart) && vendorPart != null && !string.IsNullOrEmpty(vendorPart.VendorName))
                                    {
                                        @if(!string.IsNullOrEmpty(vendorPart.VendorProductUrl))
                                        { <a href="@vendorPart.VendorProductUrl" target="_blank" rel="noopener noreferrer">@vendorPart.VendorName</a> }
                                        else { <span>@vendorPart.VendorName</span> }
                                    }
                                    else if (BuildStateService.CurrentBuild.SelectedParts.ContainsKey(subCategory.EngineSubCategoryId))
                                    { <span class="text-muted">-</span> }
                                </td>
                                <td>
                                    @if (BuildStateService.CurrentBuild.SelectedParts.TryGetValue(subCategory.EngineSubCategoryId, out Part? pricedPart) && pricedPart != null && pricedPart.BasePrice.HasValue)
                                    { <strong>@pricedPart.BasePrice.Value.ToString("C")</strong> }
                                    else if (BuildStateService.CurrentBuild.SelectedParts.ContainsKey(subCategory.EngineSubCategoryId))
                                    { <span class="text-muted">N/A</span> }
                                    else { <span class="text-muted">-</span> }
                                </td>
                                <td>
                                    @if (BuildStateService.CurrentBuild.SelectedParts.TryGetValue(subCategory.EngineSubCategoryId, out Part? existingPart) && existingPart != null)
                                    {
                                        <div class="d-flex flex-column">
                                            @if (!string.IsNullOrEmpty(existingPart.VendorProductUrl))
                                            { <a href="@existingPart.VendorProductUrl" target="_blank" rel="noopener noreferrer" class="btn btn-success btn-sm mb-1">Buy</a> }
                                            <button class="btn btn-sm btn-outline-secondary mb-1" @onclick="() => SelectOrChangePart(subCategory.EngineSubCategoryId)">Change</button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ClearPartSelection(subCategory.EngineSubCategoryId)">Clear</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick="() => SelectOrChangePart(subCategory.EngineSubCategoryId)">+ Choose A @subCategory.Name</button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    </div>
}

<style>
    .engine-builder-table th, .engine-builder-table td { vertical-align: middle; }
    .table-group-divider td {
        font-weight: bold;
        background-color: #f8f9fa; /* Light background for main category headers */
        border-top: 2px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "build")]
    public string? IncomingBuildConfigurationString { get; set; }

    [SupplyParameterFromQuery]
    public int? PassedSubCategoryId { get; set; } // RENAMED from PassedCategoryId

    [SupplyParameterFromQuery]
    public int? PassedSelectedPartId { get; set; }
// In @code block of EngineBuilderPage.razor
private HashSet<int> expandedSubCategories = new HashSet<int>();
    private List<EngineMainCategory>? engineMainCategories; // CHANGED
    private bool isLoadingCategories = true; // RENAMED
    private bool _justProcessedQueryAndNavigated = false;
    private string? shareableLink;
    private bool linkCopied = false;

    // For Save Build UI
    private string? newBuildName;
    private string? saveBuildMessage;
    private bool saveBuildSuccess = false;
    private string ReturnUrlForLogin => Navigation.ToAbsoluteUri(Navigation.Uri).ToString();

    // For expanding/collapsing main categories
    private HashSet<int> expandedMainCategories = new HashSet<int>();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("EngineBuilderPage: OnInitializedAsync - ENTERED.");
        isLoadingCategories = true;
        try
        {
            if (DbContext.EngineMainCategories != null)
    {
        engineMainCategories = await DbContext.EngineMainCategories
                                    .Include(m => m.SubCategories) // Load top-level subcategories
                                        // .ThenInclude(s => s.ChildSubCategories) // Uncomment to load one more level deep
                                    .OrderBy(m => m.DisplayOrder).ThenBy(m => m.Name)
                                    .ToListAsync();
                Console.WriteLine($"EngineBuilderPage: OnInitializedAsync - Loaded {engineMainCategories?.Count ?? 0} main categories.");
            }
            else
            {
                engineMainCategories = new List<EngineMainCategory>();
                Console.WriteLine("EngineBuilderPage: OnInitializedAsync - DbContext.EngineMainCategories DbSet is null.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"EngineBuilderPage: OnInitializedAsync - EXCEPTION while loading main categories: {ex.ToString()}");
            engineMainCategories = new List<EngineMainCategory>();
        }
        finally
        {
            isLoadingCategories = false;
        }
        Console.WriteLine("EngineBuilderPage: OnInitializedAsync - EXITED.");
    }

    protected override async Task OnParametersSetAsync()
    {
        Console.WriteLine($"EngineBuilderPage ({BuildStateService.CurrentBuild.GetHashCode()}): OnParametersSetAsync - ENTERED. BuildString: '{IncomingBuildConfigurationString}', PassedSubCatId: {PassedSubCategoryId}, PassedSelPartId: {PassedSelectedPartId}, JustProcessedFlag: {_justProcessedQueryAndNavigated}");

        if (_justProcessedQueryAndNavigated)
        {
            _justProcessedQueryAndNavigated = false;
            Console.WriteLine($"EngineBuilderPage ({BuildStateService.CurrentBuild.GetHashCode()}): OnParametersSetAsync - EXITED (early, due to URL clean-up redirect).");
            return;
        }

        bool parametersWereProcessedThisCycle = false;

        if (!string.IsNullOrWhiteSpace(IncomingBuildConfigurationString))
        {
            parametersWereProcessedThisCycle = true;
            Console.WriteLine($"EngineBuilderPage: Processing build string: {IncomingBuildConfigurationString}");
            BuildStateService.CurrentBuild.SelectedParts.Clear();

            var categoryPartPairs = IncomingBuildConfigurationString.Split('_');
            foreach (var pairString in categoryPartPairs)
            {
                var ids = pairString.Split('-');
                // The key from the build string is EngineSubCategoryId
                if (ids.Length == 2 && int.TryParse(ids[0], out int engineSubCategoryId) && int.TryParse(ids[1], out int partIdVal))
                {
                    Console.WriteLine($"EngineBuilderPage: Parsed from build string - EngineSubCategoryId: {engineSubCategoryId}, PartId: {partIdVal}");
                    if (DbContext.Parts != null)
                    {
                        var part = await DbContext.Parts
                                            .Include(p => p.SubCategory.MainCategory) // Ensure SubCategory and MainCategory are included for display
                                            .FirstOrDefaultAsync(p => p.PartId == partIdVal && p.EngineSubCategoryId == engineSubCategoryId);
                        if (part != null)
                        {
                            BuildStateService.CurrentBuild.SelectPart(engineSubCategoryId, part);
                            Console.WriteLine($"EngineBuilderPage: Loaded Part '{part.Name}' (ID: {part.PartId}) for EngineSubCategoryId {engineSubCategoryId} from build string.");
                        }
                        else { /* ... log part not found ... */ }
                    }
                } else { /* ... log parse error ... */ }
            }
        }
        else if (PassedSelectedPartId.HasValue && PassedSubCategoryId.HasValue) // PassedSubCategoryId is EngineSubCategoryId
        {
            parametersWereProcessedThisCycle = true;
            Console.WriteLine($"EngineBuilderPage: Processing direct selection - EngineSubCategoryID: {PassedSubCategoryId.Value}, PartID: {PassedSelectedPartId.Value}");
            if (DbContext.Parts != null)
            {
                var part = await DbContext.Parts.Include(p => p.SubCategory.MainCategory).FirstOrDefaultAsync(p => p.PartId == PassedSelectedPartId.Value);
                if (part != null && part.EngineSubCategoryId == PassedSubCategoryId.Value)
                {
                    BuildStateService.CurrentBuild.SelectPart(PassedSubCategoryId.Value, part); // Key is EngineSubCategoryId
                    Console.WriteLine($"EngineBuilderPage: Part '{part.Name}' selected for EngineSubCategory {PassedSubCategoryId.Value}.");
                } else { /* ... log error ... */ }
            }
        }

        if (parametersWereProcessedThisCycle)
        {
            Console.WriteLine($"EngineBuilderPage: Parameters processed. Updating UI. SelectedParts count: {BuildStateService.CurrentBuild.SelectedParts.Count}");
            StateHasChanged();
            // await Update3DPreview(); // No 3D for now

            _justProcessedQueryAndNavigated = true;
            Navigation.NavigateTo("/enginebuilder", replace: true);
            Console.WriteLine($"EngineBuilderPage: OnParametersSetAsync - EXITED (after processing and navigating).");
            return;
        }
        Console.WriteLine($"EngineBuilderPage: OnParametersSetAsync - EXITED (no new query parameters processed).");
    }

    private void SelectOrChangePart(int engineSubCategoryId)
    {
        Console.WriteLine($"EngineBuilderPage: Navigating to select part for EngineSubCategoryID: {engineSubCategoryId}");
        Navigation.NavigateTo($"/selectpart/{engineSubCategoryId}"); // PartSelectionPage expects EngineSubCategoryId
    }

    private async Task ClearPartSelection(int engineSubCategoryId)
    {
        Console.WriteLine($"EngineBuilderPage: Clearing part selection for EngineSubCategoryID: {engineSubCategoryId}");
        BuildStateService.CurrentBuild.SelectPart(engineSubCategoryId, null);
        StateHasChanged();
        // await Update3DPreview(); // No 3D
    }

    private void GenerateShareableLink()
    {
        linkCopied = false;
        Console.WriteLine("EngineBuilderPage: GenerateShareableLink - Method ENTERED.");
        if (BuildStateService.CurrentBuild.SelectedParts == null || !BuildStateService.CurrentBuild.SelectedParts.Any())
        { /* ... */ return; }

        // Key in SelectedParts is EngineSubCategoryId
        var buildParts = BuildStateService.CurrentBuild.SelectedParts
            .Where(kvp => kvp.Value != null)
            .Select(kvp => $"{kvp.Key}-{kvp.Value!.PartId}");
        string buildString = string.Join("_", buildParts);

        if (string.IsNullOrEmpty(buildString)) { /* ... */ return; }
        var builderPageUri = Navigation.ToAbsoluteUri("/enginebuilder").ToString();
        shareableLink = $"{builderPageUri}?build={buildString}";
        Console.WriteLine($"EngineBuilderPage: GenerateShareableLink - FINAL link: {shareableLink}");
    }

    private async Task CopyLinkToClipboard() { /* ... same as before ... */
        if (!string.IsNullOrEmpty(shareableLink)) {
            bool success = await JSRuntime.InvokeAsync<bool>("blazorGui.clipboardCopy.copyText", shareableLink);
            linkCopied = success;
            if (success) { _ = Task.Delay(2000).ContinueWith(_ => InvokeAsync(() => { linkCopied = false; StateHasChanged(); })); }
        }
    }
    
    [Inject] private UserManager<ApplicationUser> UserManager { get; set; } = default!;
    [Inject] private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    private async Task SaveCurrentBuild() { /* ... same as before, ensure keys used are EngineSubCategoryId if that's how build string is made ... */
        // ... (Make sure buildConfigString in SaveCurrentBuild also uses EngineSubCategoryId as the key from SelectedParts)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity == null || !user.Identity.IsAuthenticated) { /* ... */ return; }
        var appUser = await UserManager.GetUserAsync(user);
        if (appUser == null) { /* ... */ return; }

        var buildParts = BuildStateService.CurrentBuild.SelectedParts
            .Where(kvp => kvp.Value != null)
            .Select(kvp => $"{kvp.Key}-{kvp.Value!.PartId}"); // Key is EngineSubCategoryId
        string buildConfigString = string.Join("_", buildParts);
        // ... rest of save logic ...
        if (string.IsNullOrWhiteSpace(newBuildName)) { /* ... */ return; }
        var savedBuild = new UserSavedBuild { /* ... UserId, BuildName, BuildConfigurationString, Dates ... */ 
            BuildName = newBuildName,
            UserId = appUser.Id,
            BuildConfigurationString = buildConfigString,
            SavedDate = DateTime.UtcNow,
            LastModifiedDate = DateTime.UtcNow
        };
        try {
            DbContext.UserSavedBuilds.Add(savedBuild);
            await DbContext.SaveChangesAsync();
            saveBuildMessage = "Build saved!"; saveBuildSuccess = true; newBuildName = "";
        } catch (Exception ex) {
            saveBuildMessage = "Error saving build."; saveBuildSuccess = false;
            Console.WriteLine($"SaveBuild EXCEPTION: {ex}");
        }
        StateHasChanged();
    }

    private void ToggleMainCategory(int mainCategoryId)
    {
        if (expandedMainCategories.Contains(mainCategoryId))
        {
            expandedMainCategories.Remove(mainCategoryId);
        }
        else
        {
            expandedMainCategories.Add(mainCategoryId);
        }
    }
    // In @code block of EngineBuilderPage.razor
private void ToggleSubCategory(int subCategoryId)
{
    if (expandedSubCategories.Contains(subCategoryId))
    {
        expandedSubCategories.Remove(subCategoryId);
        Console.WriteLine($"EngineBuilderPage: SubCategory {subCategoryId} collapsed.");
    }
    else
    {
        expandedSubCategories.Add(subCategoryId);
        Console.WriteLine($"EngineBuilderPage: SubCategory {subCategoryId} expanded.");
    }
    // StateHasChanged(); // May not be needed if the UI updates correctly,
                       // but add it if expansion doesn't visually update.
}
// In @code block of EngineBuilderPage.razor
private bool IsSubCategoryExpanded(int subCategoryId)
{
    return expandedSubCategories.Contains(subCategoryId);
}
}